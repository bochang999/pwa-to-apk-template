name: Build PWA APK

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  NODE_VERSION: '20'
  
jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # ========== 1. ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ã‚§ãƒ¼ã‚º ==========
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}

    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    # ========== 2. ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ•ã‚§ãƒ¼ã‚º ==========
    - name: Install Dependencies
      run: |
        echo "ðŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«é–‹å§‹"
        npm ci
        npm install -g @capacitor/cli
        # CIç’°å¢ƒã§ã®ã¿@capacitor/assetsã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (Sharpä¾å­˜é–¢ä¿‚ãŒCIç’°å¢ƒã§åˆ©ç”¨å¯èƒ½)
        npm install @capacitor/assets@^3.0.5
        echo "âœ… ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"

    - name: Run Lint and Format Check
      env:
        ESLINT_USE_FLAT_CONFIG: true
      run: |
        npm run lint
        npm run format -- --check

    # ========== 3. ã‚¦ã‚§ãƒ–ã‚¢ã‚»ãƒƒãƒˆæ§‹ç¯‰ãƒ•ã‚§ãƒ¼ã‚º ==========
    - name: Validate PWA Assets
      run: |
        echo "ðŸ” PWAè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª"
        if [ -f "manifest.json" ]; then
          echo "âœ… manifest.json å­˜åœ¨ç¢ºèª"
          cat manifest.json | jq '.' > /dev/null && echo "âœ… JSONå½¢å¼æ­£å¸¸" || exit 1
        else
          echo "âŒ manifest.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          exit 1
        fi
        
        if [ -f "sw.js" ]; then
          echo "âœ… Service Workerå­˜åœ¨ç¢ºèª"
        else
          echo "âš ï¸ Service WorkerãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
        fi

    - name: Generate Version Tag
      id: version
      run: |
        VERSION_TAG="1.0.${{ github.run_number }}"
        echo "VERSION_TAG=${VERSION_TAG}" >> $GITHUB_ENV
        echo "ðŸ·ï¸ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°: ${VERSION_TAG}"

    - name: Update App Version
      run: |
        echo "ðŸ“ ã‚¢ãƒ—ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°é–‹å§‹"
        # package.jsonã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°
        jq --arg version "${{ env.VERSION_TAG }}" '.version = $version' package.json > package.json.tmp
        mv package.json.tmp package.json
        
        # manifestã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°
        jq --arg version "${{ env.VERSION_TAG }}" '.version = $version' manifest.json > manifest.json.tmp
        mv manifest.json.tmp manifest.json
        
        echo "âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ${{ env.VERSION_TAG }} ã«æ›´æ–°å®Œäº†"

    - name: Setup Keystore from GitHub Secrets
      run: |
        echo "ðŸ”‘ ã‚­ãƒ¼ã‚¹ãƒˆã‚¢è¨­å®šé–‹å§‹"
        
        if [ -z "${{ secrets.KEYSTORE_BASE64 }}" ]; then
          echo "âš ï¸ GitHub Secretsæœªè¨­å®š - PWAãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå›ºå®šã‚­ãƒ¼ã‚¹ãƒˆã‚¢ç”Ÿæˆ"
          keytool -genkeypair -v \
            -keystore template-release.keystore \
            -alias pwa-template-key \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -dname "CN=PWA Template,OU=PWA Template,O=PWA Template App,L=Tokyo,ST=Tokyo,C=JP" \
            -storepass template2024 \
            -keypass template2024
          
          echo "KEYSTORE_PASSWORD=template2024" >> $GITHUB_ENV
          echo "KEY_ALIAS=pwa-template-key" >> $GITHUB_ENV
          echo "KEY_PASSWORD=template2024" >> $GITHUB_ENV
        else
          echo "âœ… GitHub Secretsè¨­å®šæ¸ˆã¿ - æœ¬ç•ªã‚­ãƒ¼ã‚¹ãƒˆã‚¢ä½¿ç”¨"
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > your-app-release-keystore.jks
          
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV
        fi
        
        echo "ðŸ” ã‚­ãƒ¼ã‚¹ãƒˆã‚¢è¨­å®šå®Œäº†"

    # ========== 4. CapacitoråˆæœŸåŒ–ãƒ•ã‚§ãƒ¼ã‚º ==========
    - name: Build Web Assets and Prepare Capacitor
      run: |
        echo "ðŸ§ï¸ ã‚¦ã‚§ãƒ–ã‚¢ã‚»ãƒƒãƒˆãƒ“ãƒ«ãƒ‰é–‹å§‹"
        
        # distãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ”ãƒ¼
        mkdir -p dist
        cp index.html style.css script.js manifest.json sw.js dist/
        
        echo "âœ… ã‚¦ã‚§ãƒ–ã‚¢ã‚»ãƒƒãƒˆæº–å‚™å®Œäº†"

    - name: Initialize and Sync Capacitor Project
      run: |
        echo "ðŸ”„ CapacitoråŒæœŸé–‹å§‹"
        npx cap sync android
        echo "âœ… CapacitoråŒæœŸå®Œäº†"

    - name: Generate App Icons and Splash Screens (Capacitor Assets)
      run: |
        echo "ðŸŽ¨ Androidã‚¢ãƒ€ãƒ—ãƒ†ã‚£ãƒ–ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆé–‹å§‹ (Capacitorå…¬å¼ãƒ„ãƒ¼ãƒ«)"
        
        # Capacitorå…¬å¼ã‚¢ã‚»ãƒƒãƒˆãƒ„ãƒ¼ãƒ«ã§ã‚¢ãƒ€ãƒ—ãƒ†ã‚£ãƒ–ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆ
        npx @capacitor/assets generate --android
        
        # ç”Ÿæˆçµæžœç¢ºèª
        echo "âœ… ã‚¢ãƒ€ãƒ—ãƒ†ã‚£ãƒ–ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆå®Œäº†! ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«:"
        find android/app/src/main/res -name "*ic_launcher*" -o -name "*adaptive*" | sort
        
        # ã‚¢ãƒ€ãƒ—ãƒ†ã‚£ãƒ–ã‚¢ã‚¤ã‚³ãƒ³ä»•æ§˜ç¢ºèª
        if [ -d "android/app/src/main/res/mipmap-anydpi-v26" ]; then
          echo "âœ… Android 8.0+ ã‚¢ãƒ€ãƒ—ãƒ†ã‚£ãƒ–ã‚¢ã‚¤ã‚³ãƒ³å¯¾å¿œå®Œäº†"
          ls -la android/app/src/main/res/mipmap-anydpi-v26/
        else
          echo "âš ï¸ ã‚¢ãƒ€ãƒ—ãƒ†ã‚£ãƒ–ã‚¢ã‚¤ã‚³ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“"
        fi

    # ========== 5. Android APKãƒ“ãƒ«ãƒ‰ãƒ•ã‚§ãƒ¼ã‚º ==========
    - name: Build Android APK
      run: |
        echo "ðŸ§ï¸ Android APK ãƒ“ãƒ«ãƒ‰é–‹å§‹"
        cd android
        
        # Gradleãƒ©ãƒƒãƒ‘ãƒ¼ã«å®Ÿè¡Œæ¨©é™ä»˜ä¸Ž
        chmod +x ./gradlew
        
        # APKãƒ“ãƒ«ãƒ‰
        ./gradlew assembleRelease --stacktrace
        
        echo "âœ… APK ãƒ“ãƒ«ãƒ‰å®Œäº†"

    - name: Sign APK with apksigner
      id: sign_apk
      env:
        KEYSTORE_PASSWORD: ${{ env.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ env.KEY_ALIAS }}
        KEY_PASSWORD: ${{ env.KEY_PASSWORD }}
        VERSION_TAG: ${{ env.VERSION_TAG }}
      run: |
        echo "âœï¸ APKç½²åé–‹å§‹ (Modern apksigner with Dynamic Keystore Detection)"
        
        cd android/app/build/outputs/apk/release
        
        # æœ€æ–°ã®Android build-toolsã®ãƒ‘ã‚¹ã‚’å–å¾—
        BUILD_TOOLS_PATH=$(ls -d $ANDROID_HOME/build-tools/* | sort -r | head -n 1)
        echo "ðŸ”§ ä½¿ç”¨build-tools: $BUILD_TOOLS_PATH"
        
        # å‹•çš„ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ ï¼ˆRecipeBoxæ–¹å¼ï¼‰
        if [ -f "../../../../../../your-app-release-keystore.jks" ]; then
          KEYSTORE_FILE="../../../../../../your-app-release-keystore.jks"
          echo "ðŸ”‘ æœ¬ç•ªã‚­ãƒ¼ã‚¹ãƒˆã‚¢ä½¿ç”¨: your-app-release-keystore.jks"
        elif [ -f "../../../../../../template-release.keystore" ]; then
          KEYSTORE_FILE="../../../../../../template-release.keystore"
          echo "ðŸ”‘ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ä½¿ç”¨: template-release.keystore"
        else
          echo "âŒ ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          ls -la ../../../../../../*.keystore ../../../../../../*.jks 2>/dev/null || echo "ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          exit 1
        fi
        
        echo "ðŸ”‘ ä½¿ç”¨ã‚­ãƒ¼ã‚¹ãƒˆã‚¢: $KEYSTORE_FILE"
        
        # APKç½²å (signature scheme v2å¯¾å¿œ)
        $BUILD_TOOLS_PATH/apksigner sign \
          --ks "$KEYSTORE_FILE" \
          --ks-key-alias "$KEY_ALIAS" \
          --ks-pass env:KEYSTORE_PASSWORD \
          --key-pass env:KEY_PASSWORD \
          --out pwa-app_$VERSION_TAG.apk \
          app-release-unsigned.apk
        
        # ç½²åæ¤œè¨¼
        $BUILD_TOOLS_PATH/apksigner verify pwa-app_$VERSION_TAG.apk
        
        echo "ðŸŽ¯ ç½²åå®Œäº† (v2å¯¾å¿œ): pwa-app_$VERSION_TAG.apk"

    - name: Verify APK
      run: |
        echo "ðŸ” APKæ¤œè¨¼é–‹å§‹"
        
        APK_PATH="android/app/build/outputs/apk/release/pwa-app_${{ env.VERSION_TAG }}.apk"
        
        if [ -f "$APK_PATH" ]; then
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "âœ… APKç”ŸæˆæˆåŠŸ: $APK_SIZE"
          
          # APKæƒ…å ±è¡¨ç¤º
          $ANDROID_HOME/build-tools/$(ls $ANDROID_HOME/build-tools | tail -1)/aapt dump badging "$APK_PATH" | head -5
        else
          echo "âŒ APKç”Ÿæˆå¤±æ•—"
          exit 1
        fi

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: PWA-APP-APK-${{ env.VERSION_TAG }}
        path: android/app/build/outputs/apk/release/pwa-app_${{ env.VERSION_TAG }}.apk
        retention-days: 30

    - name: Create Release (on main branch)
      if: github.ref == 'refs/heads/main'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ env.VERSION_TAG }}
        release_name: PWA App v${{ env.VERSION_TAG }}
        body: |
          ## ðŸ“± PWA App APK v${{ env.VERSION_TAG }}
          
          ### âœ¨ ã‚¢ãƒ—ãƒªæ©Ÿèƒ½
          - ðŸ“± PWA (Progressive Web App) å¯¾å¿œ
          - ðŸ’¾ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å‹•ä½œ
          - ðŸ”„ è‡ªå‹•æ›´æ–°æ©Ÿèƒ½
          - ðŸ“± ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªé¢¨UI/UX
          - ðŸš€ é«˜é€Ÿèµ·å‹•
          
          ### ðŸ› ï¸ é–‹ç™ºç’°å¢ƒ
          - Node.js ${{ env.NODE_VERSION }}
          - Java JDK ${{ env.JAVA_VERSION }}
          - Capacitor 7.x
          - GitHub Actionsè‡ªå‹•ãƒ“ãƒ«ãƒ‰
          
          ### ðŸ“‹ ä½¿ç”¨æ–¹æ³•
          1. APKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. Androidç«¯æœ«ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          3. PWAã‚¢ãƒ—ãƒªã‚’åˆ©ç”¨é–‹å§‹
          
          **APKãƒ•ã‚¡ã‚¤ãƒ«**: PWA-APP-APK-${{ env.VERSION_TAG }}
        draft: false
        prerelease: false

    - name: Build Summary
      run: |
        echo "## ðŸŽ¯ PWA App APK Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| é …ç›® | å€¤ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
        echo "| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ${{ env.VERSION_TAG }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Node.js | ${{ env.NODE_VERSION }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Java JDK | ${{ env.JAVA_VERSION }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ãƒ–ãƒ©ãƒ³ãƒ | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ã‚³ãƒŸãƒƒãƒˆ | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ æˆæžœç‰©" >> $GITHUB_STEP_SUMMARY
        echo "- APKãƒ•ã‚¡ã‚¤ãƒ«: \`pwa-app_${{ env.VERSION_TAG }}.apk\`" >> $GITHUB_STEP_SUMMARY
        echo "- ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ: PWA-APP-APK-${{ env.VERSION_TAG }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš€ **PWA App APKãƒ“ãƒ«ãƒ‰ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼**" >> $GITHUB_STEP_SUMMARY

    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}