name: Build RecipeBox APK

on:
  push:
    branches: [ main, develop, feature/rebuild-from-template ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '20'
  
jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # ========== 1. 環境セットアップフェーズ ==========
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}

    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    # ========== 2. 依存関係インストールフェーズ ==========
    - name: Install Dependencies
      run: |
        echo "📦 依存関係インストール開始"
        npm ci
        npm install -g @capacitor/cli
        echo "✅ 依存関係インストール完了"

    # ========== 3. ウェブアセット構築フェーズ ==========
    - name: Validate PWA Assets
      run: |
        echo "🔍 PWA設定ファイル確認"
        if [ -f "manifest.json" ]; then
          echo "✅ manifest.json 存在確認"
          cat manifest.json | jq '.' > /dev/null && echo "✅ JSON形式正常" || exit 1
        else
          echo "❌ manifest.json が見つかりません"
          exit 1
        fi
        
        if [ -f "sw.js" ]; then
          echo "✅ Service Worker存在確認"
        else
          echo "⚠️ Service Workerがありません（オプション）"
        fi

    - name: Generate Version Tag
      id: version
      run: |
        VERSION_TAG="1.0.${{ github.run_number }}"
        echo "VERSION_TAG=${VERSION_TAG}" >> $GITHUB_ENV
        echo "🏷️ バージョンタグ: ${VERSION_TAG}"

    - name: Update App Version
      run: |
        echo "📝 アプリバージョン更新開始"
        # package.jsonのバージョン更新
        jq --arg version "${{ env.VERSION_TAG }}" '.version = $version' package.json > package.json.tmp
        mv package.json.tmp package.json
        
        # manifestのバージョン更新
        jq --arg version "${{ env.VERSION_TAG }}" '.version = $version' manifest.json > manifest.json.tmp
        mv manifest.json.tmp manifest.json
        
        echo "✅ バージョン ${{ env.VERSION_TAG }} に更新完了"

    - name: Setup Keystore from GitHub Secrets
      run: |
        echo "🔑 キーストア設定開始"
        
        if [ -z "${{ secrets.KEYSTORE_B64 }}" ]; then
          echo "⚠️ GitHub Secrets未設定 - テンプレート用キーストア生成"
          keytool -genkeypair -v \
            -keystore template-release.keystore \
            -alias template-key \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -dname "CN=PWA Template,OU=Template,O=Development,L=Tokyo,ST=Tokyo,C=JP" \
            -storepass template123 \
            -keypass template123
          
          echo "KEYSTORE_PASSWORD=template123" >> $GITHUB_ENV
          echo "KEY_ALIAS=template-key" >> $GITHUB_ENV
          echo "KEY_PASSWORD=template123" >> $GITHUB_ENV
        else
          echo "✅ GitHub Secrets設定済み - 本番キーストア使用"
          echo "${{ secrets.KEYSTORE_B64 }}" | base64 --decode > template-release.keystore
          
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV
        fi
        
        echo "🔐 キーストア設定完了"

    # ========== 4. Capacitor初期化フェーズ ==========
    - name: Build Web Assets and Prepare Capacitor
      run: |
        echo "🏧️ ウェブアセットビルド開始"
        
        # distディレクトリ作成とファイルコピー
        mkdir -p dist
        cp index.html style.css script.js manifest.json sw.js config.js dist/
        
        # 既存Androidディレクトリ削除（クリーンスタート）
        if [ -d "android" ]; then
          echo "🗑️ 既存Androidディレクトリを削除"
          rm -rf android
        fi
        
        echo "✅ ウェブアセット準備完了"

    - name: Initialize and Sync Capacitor Project
      run: |
        echo "🔧 Capacitorプラットフォーム追加開始"
        npx cap add android
        echo "✅ Androidプラットフォーム追加完了"
        
        echo "🔄 Capacitor同期開始"
        npx cap sync android
        echo "✅ Capacitor同期完了"

    # ========== 5. Android APKビルドフェーズ ==========
    - name: Build Android APK
      run: |
        echo "🏧️ Android APK ビルド開始"
        cd android
        
        # Gradleラッパーに実行権限付与
        chmod +x ./gradlew
        
        # APKビルド
        ./gradlew assembleRelease --stacktrace
        
        echo "✅ APK ビルド完了"

    - name: Sign APK
      run: |
        echo "✍️ APK署名開始"
        
        cd android/app/build/outputs/apk/release
        
        # APK署名
        jarsigner -verbose \
          -keystore ../../../../../template-release.keystore \
          -storepass ${{ env.KEYSTORE_PASSWORD }} \
          -keypass ${{ env.KEY_PASSWORD }} \
          -signedjar app-release-signed.apk \
          app-release-unsigned.apk \
          ${{ env.KEY_ALIAS }}
        
        # zipalign実行
        $ANDROID_HOME/build-tools/$(ls $ANDROID_HOME/build-tools | tail -1)/zipalign -v 4 \
          app-release-signed.apk \
          recipebox_${{ env.VERSION_TAG }}.apk
        
        echo "🎯 署名完了: recipebox_${{ env.VERSION_TAG }}.apk"

    - name: Verify APK
      run: |
        echo "🔍 APK検証開始"
        
        APK_PATH="android/app/build/outputs/apk/release/recipebox_${{ env.VERSION_TAG }}.apk"
        
        if [ -f "$APK_PATH" ]; then
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "✅ APK生成成功: $APK_SIZE"
          
          # APK情報表示
          $ANDROID_HOME/build-tools/$(ls $ANDROID_HOME/build-tools | tail -1)/aapt dump badging "$APK_PATH" | head -5
        else
          echo "❌ APK生成失敗"
          exit 1
        fi

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: RecipeBox-APK-${{ env.VERSION_TAG }}
        path: android/app/build/outputs/apk/release/recipebox_${{ env.VERSION_TAG }}.apk
        retention-days: 30

    - name: Create Release (on main branch)
      if: github.ref == 'refs/heads/main'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ env.VERSION_TAG }}
        release_name: RecipeBox v${{ env.VERSION_TAG }}
        body: |
          ## 📱 RecipeBox APK v${{ env.VERSION_TAG }}
          
          ### ✨ アプリ機能
          - 📝 レシピ管理システム
          - 🔢 分量調整機能
          - 🧂 塩分濃度計算
          - 💾 LocalStorage自動保存
          - 🔄 PWA対応
          
          ### 🛠️ 開発環境
          - Node.js ${{ env.NODE_VERSION }}
          - Java JDK ${{ env.JAVA_VERSION }}
          - Capacitor 7.x
          - GitHub Actions自動ビルド
          
          ### 📋 使用方法
          1. APKをダウンロード
          2. Android端末にインストール
          3. レシピを登録・管理
          
          **APKファイル**: RecipeBox-APK-${{ env.VERSION_TAG }}
        draft: false
        prerelease: false

    - name: Build Summary
      run: |
        echo "## 🎯 RecipeBox APK Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| 項目 | 値 |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
        echo "| バージョン | ${{ env.VERSION_TAG }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Node.js | ${{ env.NODE_VERSION }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Java JDK | ${{ env.JAVA_VERSION }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ブランチ | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| コミット | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📦 成果物" >> $GITHUB_STEP_SUMMARY
        echo "- APKファイル: \`recipebox_${{ env.VERSION_TAG }}.apk\`" >> $GITHUB_STEP_SUMMARY
        echo "- アーティファクト: RecipeBox-APK-${{ env.VERSION_TAG }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "🚀 **RecipeBox APKビルドが正常に完了しました！**" >> $GITHUB_STEP_SUMMARY